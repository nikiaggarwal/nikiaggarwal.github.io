<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Mamdani Meter | The Mamdani Meter</title>
  <meta name="description" content="Tracking promises, policies, and progress at NYC City Hall" />
  <link rel="canonical" href="https://example.com/" />
  <meta property="og:title" content="The Mamdani Meter" />
  <meta property="og:description" content="Tracking promises, policies, and progress at NYC City Hall" />
  <meta property="og:type" content="website" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=IBM+Plex+Sans:wght@400;600;700;800;900&family=IBM+Plex+Mono:wght@400;600&display=swap"
    rel="stylesheet"
  />

  <!-- Global Styles -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <!-- NAV -->
  <header class="nav" role="banner">
    <div class="nav-inner">
      <a class="brand" href="/" aria-label="The Mamdani Meter home">
        <!-- small static meter icon -->
        <svg width="28" height="28" viewBox="0 0 28 28" aria-hidden="true">
          <path d="M4 18a10 10 0 0 1 20 0" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="square"/>
        </svg>
        <span>THE MAMDANI METER</span>
      </a>

      <nav aria-label="Primary">
        <ul class="nav-links">
          <li><a href="/" aria-current="page">Home</a></li>
          <li><a href="/promises.html">Promises</a></li>
          <li><a href="/updates.html">What Just Happened</a></li>
          <li><a href="/about.html">About</a></li>
          <li><a href="/subscribe.html">Subscribe</a></li>
        </ul>
      </nav>

      <button class="hamburger" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- MOBILE MENU -->
  <div id="mobileMenu" class="mobile-overlay" role="dialog" aria-modal="true" aria-label="Mobile menu" hidden>
    <div class="mobile-top">
      <div class="title">Menu</div>
      <button class="mobile-close" type="button" aria-label="Close menu">Close</button>
    </div>
    <ul class="mobile-menu">
      <li><a href="/" aria-current="page">Home</a></li>
      <li><a href="/promises.html">Promises</a></li>
      <li><a href="/updates.html">What Just Happened</a></li>
      <li><a href="/about.html">About</a></li>
      <li><a href="/subscribe.html">Subscribe</a></li>
    </ul>
  </div>

  <main id="main">
    <!-- HERO -->
    <section class="hero">
      <div class="hero-inner">
        <div class="h1">THE MAMDANI METER</div>
        <p class="hero-sub">
          Tracking promises, policies, and progress at NYC City Hall.
        </p>
        <div id="heroTimestamp" class="hero-time mono">Last updated: —</div>

        <div class="meter-wrap">
          <div id="overallStatusLabel" class="overall-label">MAKING PROGRESS</div>
          <!-- Large Meter -->
          <div id="meterA11yWrap" tabindex="0" role="img" aria-label="Status: Making Progress - Momentum Building">
            <svg id="largeMeter" width="240" height="240" viewBox="0 0 240 240" aria-hidden="true">
              <!-- Colored segments for all 5 statuses (always visible) -->
              <path id="segmentNope" d="" fill="none" stroke="#ff3333" stroke-width="16" stroke-linecap="butt"/>
              <path id="segmentHeadwinds" d="" fill="none" stroke="#ffaa0f" stroke-width="16" stroke-linecap="butt"/>
              <path id="segmentEarlyDays" d="" fill="none" stroke="#00d4ff" stroke-width="16" stroke-linecap="butt"/>
              <path id="segmentMakingProgress" d="" fill="none" stroke="#0033cc" stroke-width="16" stroke-linecap="butt"/>
              <path id="segmentDelivered" d="" fill="none" stroke="#00CC66" stroke-width="16" stroke-linecap="butt"/>

              <!-- Center photo clip path -->
              <defs>
                <clipPath id="photoClip">
                  <circle cx="120" cy="120" r="40"></circle>
                </clipPath>
              </defs>

              <!-- Needle -->
              <g id="needleGroup" transform="rotate(270 120 120)">
                <!-- Clock-hand style: wide base tapering to point -->
                <path d="M120 120 L116 122 L120 44 L124 122 Z" fill="#1a1a1a"></path>
                <!-- Tip arrow -->
                <path d="M120 40 L114 50 L126 50 Z" fill="#1a1a1a"></path>
                <!-- Base anchor -->
                <circle cx="120" cy="120" r="6" fill="#1a1a1a"></circle>
                <circle cx="120" cy="120" r="8" fill="none" stroke="#1a1a1a" stroke-width="2"></circle>
              </g>

              <!-- Center photo (on top of needle) -->
              <circle cx="120" cy="120" r="43" fill="#fff" stroke="#fff" stroke-width="3"></circle>
              <image id="centerImage" href="" x="80" y="80" width="80" height="80" clip-path="url(#photoClip)" preserveAspectRatio="xMidYMid slice"/>
              <circle cx="120" cy="120" r="40" fill="none" stroke="#ffffff" stroke-width="3"></circle>
            </svg>
          </div>
          <div id="overallStatusDescription" class="overall-description">Momentum Building</div>
        </div>
      </div>
    </section>

    <!-- WHAT JUST HAPPENED -->
    <section class="what-happened">
      <div class="container">
        <div class="section-head">
          <div class="h2">WHAT JUST HAPPENED</div>
        </div>

        <div class="updates" role="list" aria-label="Latest updates">
          <!-- Updates will be loaded dynamically from Google Sheets -->
        </div>
      </div>
    </section>

    <!-- THE PROMISES -->
    <section class="promises">
      <div class="container">
        <div class="section-head">
          <div class="h2">THE PROMISES</div>
          <div class="promises-sub">
            Six promises we’re watching closely right now—across housing, transit, education, and labor.
          </div>
        </div>

        <div id="promiseGrid" class="grid" aria-label="Promises grid">
          <!-- Cards injected by JS (keeps statuses/colors consistent) -->
        </div>

        <div class="cta-row">
          <a class="btn btn-primary" href="/promises.html">View All Promises</a>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-links" aria-label="Footer links">
        <a href="/about.html">ABOUT</a>
        <a href="/contact.html">CONTACT</a>
        <a href="/methodology.html">METHODOLOGY</a>
      </div>
    </div>
  </footer>

  <script>
    // --------------------------
    // GOOGLE SHEETS CONFIGURATION
    // Replace these URLs with your published Google Sheets CSV URLs
    // See SHEETS_SETUP.md for instructions
    // --------------------------
    const SHEETS_CONFIG = {
      promises: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWWrJFChdFmerrKCrVf1fLiVmXFiTpaXdPxk1xGtLToZRiB3V3FXWoNAsl3cQmmyueJaroRaZrIQZ1/pub?gid=0&single=true&output=csv",
      updates: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWWrJFChdFmerrKCrVf1fLiVmXFiTpaXdPxk1xGtLToZRiB3V3FXWoNAsl3cQmmyueJaroRaZrIQZ1/pub?gid=1426316595&single=true&output=csv",
      overall: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWWrJFChdFmerrKCrVf1fLiVmXFiTpaXdPxk1xGtLToZRiB3V3FXWoNAsl3cQmmyueJaroRaZrIQZ1/pub?gid=288337905&single=true&output=csv",
      cacheDuration: 5 * 60 * 1000 // 5 minutes
    };

    // --------------------------
    // Fallback data (used if sheets fail to load)
    // --------------------------
    const FALLBACK_DATA = {
      overallStatus: {
        status: "Early Days",
        label: "Momentum Building",
        lastUpdated: "2026-01-18T19:45:00-05:00"
      },
      promises: [
        {
          id: "p1",
          title: "Fund tenant legal support citywide",
          category: "Housing",
          status: "Oof",
          statusLabel: "Budget pending",
          oneLineSummary: "Funding discussions are active, but no final commitment yet."
        },
        {
          id: "p2",
          title: "Expand bus lanes on key corridors",
          category: "Transit",
          status: "Alright-Alright",
          statusLabel: "In motion",
          oneLineSummary: "Agencies are coordinating next steps and public input."
        },
        {
          id: "p3",
          title: "Launch paid youth internships",
          category: "Education",
          status: "LET'S GOOO",
          statusLabel: "Pilot live",
          oneLineSummary: "A pilot program is running with early results expected soon."
        },
        {
          id: "p4",
          title: "Improve subway accessibility timelines",
          category: "Transit",
          status: "Yikes",
          statusLabel: "Stalled",
          oneLineSummary: "No clear plan or timeline has been published."
        },
        {
          id: "p5",
          title: "Strengthen workplace protections",
          category: "Labor",
          status: "Alright-Alright",
          statusLabel: "Drafting",
          oneLineSummary: "Policy language is taking shape with stakeholder feedback."
        },
        {
          id: "p6",
          title: "Build more deeply affordable housing",
          category: "Housing",
          status: "Oof",
          statusLabel: "Negotiating",
          oneLineSummary: "Key details depend on land, financing, and approvals."
        }
      ],
      updates: [
        {
          date: "01/18",
          promiseId: "123",
          headline: "Council hearing scheduled for bus lane expansion",
          category: "Transit"
        },
        {
          date: "01/12",
          promiseId: "456",
          headline: "Draft bill released for tenant legal support funding",
          category: "Housing"
        },
        {
          date: "01/04",
          promiseId: "789",
          headline: "Pilot announced for after-school paid internships",
          category: "Education"
        }
      ]
    };

    // --------------------------
    // Data variables (will be populated from sheets or fallback)
    // --------------------------
    let overallStatus = FALLBACK_DATA.overallStatus;
    let promises = FALLBACK_DATA.promises;
    let updates = FALLBACK_DATA.updates;

    // --------------------------
    // Google Sheets CSV Parser
    // --------------------------
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        rows.push(row);
      }

      return rows;
    }

    // --------------------------
    // Fetch data from Google Sheets with caching
    // --------------------------
    async function fetchSheet(url, cacheKey) {
      // Check cache first
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp < SHEETS_CONFIG.cacheDuration) {
          return data;
        }
      }

      // Fetch fresh data
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const text = await response.text();
        const data = parseCSV(text);

        // Cache the result
        localStorage.setItem(cacheKey, JSON.stringify({
          data,
          timestamp: Date.now()
        }));

        return data;
      } catch (error) {
        console.warn(`Failed to fetch ${cacheKey}:`, error);
        // Return cached data if available, even if expired
        if (cached) {
          return JSON.parse(cached).data;
        }
        throw error;
      }
    }

    // --------------------------
    // Load all data from Google Sheets
    // --------------------------
    async function loadData() {
      try {
        // Only fetch if URLs are configured
        if (SHEETS_CONFIG.promises !== "YOUR_PROMISES_SHEET_URL_HERE") {
          promises = await fetchSheet(SHEETS_CONFIG.promises, 'promises_cache');
        }

        if (SHEETS_CONFIG.updates !== "YOUR_UPDATES_SHEET_URL_HERE") {
          updates = await fetchSheet(SHEETS_CONFIG.updates, 'updates_cache');
        }

        if (SHEETS_CONFIG.overall !== "YOUR_OVERALL_SHEET_URL_HERE") {
          const overallData = await fetchSheet(SHEETS_CONFIG.overall, 'overall_cache');
          if (overallData && overallData.length > 0) {
            overallStatus = overallData[0];
          }
        }

        console.log('✓ Data loaded from Google Sheets');
      } catch (error) {
        console.warn('Using fallback data:', error);
      }

      // Render the page with loaded data
      renderPage();
    }

    // --------------------------
    // Helpers: status -> colors/tints/images
    // --------------------------
    const STATUS = {
      "Delivered": { color: getCSS("--status-lets"), tint: "rgba(0, 204, 102, 0.08)", image: "images/delivered.png" },
      "Making Progress": { color: getCSS("--status-alright"), tint: "rgba(0, 51, 204, 0.08)", image: "images/making-progress.png" },
      "Early Days": { color: getCSS("--status-early"), tint: "rgba(29, 222, 228, 0.08)", image: "images/early-days.png" },
      "Headwinds": { color: getCSS("--status-oof"), tint: "rgba(255, 170, 15, 0.08)", image: "images/headwinds.png" },
      "Nope": { color: getCSS("--status-yikes"), tint: "rgba(255, 51, 51, 0.08)", image: "images/nope.png" }
    };

    function getCSS(varName){
      return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    }

    function formatLastUpdated(iso){
      try{
        const d = new Date(iso);
        const opts = { year:"numeric", month:"long", day:"numeric", hour:"numeric", minute:"2-digit" };
        return d.toLocaleString(undefined, opts);
      } catch(e){
        return iso;
      }
    }

    // --------------------------
    // Render all dynamic content
    // --------------------------
    function renderPage() {
      renderHeroSection();
      renderUpdatesSection();
      renderPromisesSection();
    }

    function renderHeroSection() {
      const tsEl = document.getElementById("heroTimestamp");
      tsEl.textContent = "Last updated: " + formatLastUpdated(overallStatus.lastUpdated);

      const overallLabelEl = document.getElementById("overallStatusLabel");
      overallLabelEl.textContent = overallStatus.status.toUpperCase();

      const overallDescEl = document.getElementById("overallStatusDescription");
      overallDescEl.textContent = overallStatus.label || "";

      // Update meter a11y label
      const meterA11y = document.getElementById("meterA11yWrap");
      meterA11y.setAttribute("aria-label", `Status: ${overallStatus.status} - ${overallStatus.label}`);

      setMeterStatus(overallStatus.status);
    }

    function renderUpdatesSection() {
      const updatesContainer = document.querySelector('.updates');
      if (!updatesContainer) return;

      updatesContainer.innerHTML = '';

      updates.slice(0, 3).forEach(update => {
        const a = document.createElement('a');
        a.className = 'update-item';
        a.setAttribute('role', 'listitem');
        a.href = `/promise/${encodeURIComponent(update.promiseId)}`;
        a.setAttribute('aria-label', `Update: ${update.headline} (${update.category})`);

        a.innerHTML = `
          <div class="update-date">${escapeHTML(update.date)}</div>
          <div class="update-meter" aria-hidden="true">
            <span style="font-weight:900;">M</span>
          </div>
          <div class="update-content">
            <div class="update-headline">${escapeHTML(update.headline)}</div>
            <div class="update-cat">${escapeHTML(update.category)}</div>
          </div>
          <svg class="update-arrow" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M9 6l6 6-6 6" />
          </svg>
        `;

        updatesContainer.appendChild(a);
      });
    }

    function renderPromisesSection() {
      const grid = document.getElementById("promiseGrid");
      if (!grid) return;

      grid.innerHTML = '';
      promises.slice(0, 6).forEach(p => grid.appendChild(makeCard(p)));
    }

    // --------------------------
    // Large Meter SVG geometry (180° arc, open at bottom)
    // --------------------------
    const svg = document.getElementById("largeMeter");
    const segmentNope = document.getElementById("segmentNope");
    const segmentHeadwinds = document.getElementById("segmentHeadwinds");
    const segmentEarlyDays = document.getElementById("segmentEarlyDays");
    const segmentMakingProgress = document.getElementById("segmentMakingProgress");
    const segmentDelivered = document.getElementById("segmentDelivered");
    const needle = document.getElementById("needleGroup");

    // Arc settings
    const cx = 120, cy = 120;
    const r = 88;            // radius for 240x240 with 16px stroke
    const startDeg = 270;    // bottom-left (9 o'clock position)
    const endDeg = 90;       // top-right (3 o'clock position)
    const sweepDeg = 180;    // 180 degree arc from 270° to 90°

    function polarToCartesian(cx, cy, r, deg){
      const rad = (deg - 90) * Math.PI / 180;
      return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
    }

    function describeArc(cx, cy, r, startAngle, endAngle){
      const start = polarToCartesian(cx, cy, r, endAngle);
      const end = polarToCartesian(cx, cy, r, startAngle);
      // Calculate sweep angle, handling wraparound
      let sweepAngle = endAngle - startAngle;
      if (sweepAngle < 0) sweepAngle += 360;
      const largeArcFlag = (sweepAngle <= 180) ? "0" : "1";
      return ["M", start.x, start.y, "A", r, r, 0, largeArcFlag, 0, end.x, end.y].join(" ");
    }

    // Create 5 colored segments for the statuses
    // Each segment is 36 degrees (180° / 5 = 36°)
    // Going from 270° (left) clockwise to 90° (right) through bottom
    const segmentDeg = 36;

    // Nope: 270° to 306° (0-20%)
    const nopeArc = describeArc(cx, cy, r, 270, 306);
    segmentNope.setAttribute("d", nopeArc);

    // Headwinds: 306° to 342° (20-40%)
    const headwindsArc = describeArc(cx, cy, r, 306, 342);
    segmentHeadwinds.setAttribute("d", headwindsArc);

    // Early Days: 342° to 18° (going through 360°/0°) (40-60%)
    const earlyDaysArc = describeArc(cx, cy, r, 342, 18);
    segmentEarlyDays.setAttribute("d", earlyDaysArc);

    // Making Progress: 18° to 54° (60-80%)
    const makingProgressArc = describeArc(cx, cy, r, 18, 54);
    segmentMakingProgress.setAttribute("d", makingProgressArc);

    // Delivered: 54° to 90° (80-100%)
    const deliveredArc = describeArc(cx, cy, r, 54, 90);
    segmentDelivered.setAttribute("d", deliveredArc);

    // --------------------------
    // Status -> needle position and active arc amount
    // --------------------------
    // Needle animation: from 0% (start at 270°) to target bucket
    // Buckets from 270° (Nope/0%) to 90° (Delivered/100%):
    // Delivered: 100% (at 90°)
    // Making Progress: 60-75%
    // Early Days: 40-55%
    // Headwinds: 20-35%
    // Nope: 0% (at 270°)
    const BUCKETS = {
      "Delivered": { pct: 1.0, labelPct: 0.95 },
      "Making Progress": { pct: 0.675, labelPct: 0.67 },
      "Early Days": { pct: 0.475, labelPct: 0.47 },
      "Headwinds": { pct: 0.275, labelPct: 0.27 },
      "Nope": { pct: 0.0, labelPct: 0.05 }
    };

    function setMeterStatus(status){
      const s = STATUS[status] || STATUS["Headwinds"];
      const b = BUCKETS[status] || BUCKETS["Headwinds"];

      // Update center image
      const centerImage = document.getElementById("centerImage");
      if (centerImage && s.image) {
        centerImage.setAttribute("href", s.image);
      }

      // Needle target rotation:
      // Our needleGroup starts at 270° (0% - Nope position).
      // We map pct -> rotation from 270° to 90° (180° sweep).
      const startAngle = 270;
      const target = startAngle + (sweepDeg * b.pct);

      // Animate needle using Web Animations API (respects reduced motion via CSS)
      try{
        needle.animate(
          [
            { transform: "rotate(270deg)", transformOrigin: "120px 120px" },
            { transform: `rotate(${target}deg)`, transformOrigin: "120px 120px" }
          ],
          { duration: 800, easing: "cubic-bezier(0.2, 0.9, 0.2, 1)", fill: "forwards" }
        );
      } catch(e){
        needle.setAttribute("transform", `rotate(${target} 120 120)`);
      }
    }

    // --------------------------
    // Render Promise Cards
    // --------------------------
    function makeCard(p){
      const s = STATUS[p.status] || STATUS["Oof"];

      const a = document.createElement("a");
      a.className = "card";
      a.href = `/promise/${encodeURIComponent(p.id)}`;
      a.setAttribute("aria-label", `Promise: ${p.title}. Category: ${p.category}. Status: ${p.status}. ${p.statusLabel}.`);

      // Tint background
      a.style.background = s.tint;

      // Hover border color shifts to status color
      a.addEventListener("mouseenter", () => { a.style.borderColor = s.color; });
      a.addEventListener("mouseleave", () => { a.style.borderColor = "#000"; });

      a.innerHTML = `
        <div class="badge" style="background:${s.color}">${p.status.toUpperCase()}</div>
        <div class="card-title">${escapeHTML(p.title)}</div>
        <div class="card-cat label">${escapeHTML(p.category)}</div>
        <div class="card-status" style="color:${s.color}">${escapeHTML(p.statusLabel)}</div>
        <div class="card-meta">${escapeHTML(p.oneLineSummary)}</div>
      `;
      return a;
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // --------------------------
    // Initialize the page
    // --------------------------
    loadData();

    // --------------------------
    // Mobile menu interactions + focus management
    // --------------------------
    const hamburger = document.querySelector(".hamburger");
    const overlay = document.getElementById("mobileMenu");
    const closeBtn = document.querySelector(".mobile-close");
    let lastFocus = null;

    function openMenu(){
      lastFocus = document.activeElement;
      overlay.hidden = false;
      requestAnimationFrame(() => overlay.classList.add("open"));
      hamburger.setAttribute("aria-expanded","true");
      closeBtn.focus();
      document.body.style.overflow = "hidden";
    }
    function closeMenu(){
      overlay.classList.remove("open");
      hamburger.setAttribute("aria-expanded","false");
      document.body.style.overflow = "";
      setTimeout(() => {
        overlay.hidden = true;
        if(lastFocus) lastFocus.focus();
      }, 260);
    }

    hamburger.addEventListener("click", () => {
      const expanded = hamburger.getAttribute("aria-expanded") === "true";
      expanded ? closeMenu() : openMenu();
    });
    closeBtn.addEventListener("click", closeMenu);

    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) closeMenu();
    });
    document.addEventListener("keydown", (e) => {
      if(!overlay.hidden && e.key === "Escape") closeMenu();
    });
  </script>
</body>
</html>

